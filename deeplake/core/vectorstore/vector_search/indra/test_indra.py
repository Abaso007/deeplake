import numpy as np
import pytest

import deeplake
from deeplake.core.vectorstore.vector_search.indra import query
from deeplake.core.vectorstore.vector_search.indra.tql_distance_metrics import (
    get_tql_distance_metric,
)
from deeplake.core.vectorstore.deeplake_vectorstore import VectorStore

array = "ARRAY[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0]"
METRIC_FUNC_TO_METRIC_STRING = {
    "l1": f"L1_NORM(embedding-{array})",
    "l2": f"L2_NORM(embedding-{array})",
    "cos": f"COSINE_SIMILARITY(embedding, {array})",
    "max": f"LINF_NORM(embedding-{array})",
}


def create_tql_string(metric_function, order="ASC"):
    return f"select * from (select *, {METRIC_FUNC_TO_METRIC_STRING[metric_function]} as score) order by score {order} limit 10"


METRIC_FUNC_TO_QUERY_STRING = {
    "l1": create_tql_string("l1", order="ASC"),
    "l2": create_tql_string("l2", order="ASC"),
    "cos": create_tql_string("cos", order="DESC"),
    "max": create_tql_string("max", order="ASC"),
}


@pytest.mark.parametrize(
    "metric",
    [
        "l1",
        "l2",
        "cos",
        "max",
    ],
)
def test_metric_to_tql_metric(metric):
    query_embedding = np.array([[1, 2, 3, 4, 5, 6, 7, 8]], dtype=np.float32)
    query_str = query.convert_tensor_to_str(query_embedding)
    parsed_query = get_tql_distance_metric(metric, "embedding", query_str)
    assert parsed_query == METRIC_FUNC_TO_METRIC_STRING[metric]


@pytest.mark.parametrize(
    "metric",
    [
        "l1",
        "l2",
        "cos",
        "max",
    ],
)
def test_tql_metric_to_tql_str(metric, limit=10):
    query_embedding = np.array([[1, 2, 3, 4, 5, 6, 7, 8]], dtype=np.float32)
    embedding_tensor = "embedding"

    parsed_query = query.parse_query(
        metric, 10, query_embedding, embedding_tensor, "", ["*"]
    )
    assert parsed_query == METRIC_FUNC_TO_QUERY_STRING[metric]


def test_search_resulting_shapes():
    vector_store = VectorStore("hub://activeloop/paul_graham_essay", read_only=True)
    search_text = "What I Worked On"

    def filter_fn(x):
        return search_text in x["text"].data()["value"]

    TQL_QUERY = f"select * from (select *, L2_NORM(embedding-ARRAY[0.0008561203139834106, -0.023333245888352394, -0.000515342690050602, -0.015194674022495747, 0.021422218531370163, 0.016490966081619263, -0.025698643177747726, 0.0029283491894602776, -0.012348177842795849, -0.0065616401843726635, 0.02891932614147663, 0.042176246643066406, -0.0164642371237278, -0.006915781646966934, -0.016597876325249672, 0.017078973352909088, 0.019631465896964073, 0.000591767078731209, 0.008552851155400276, -0.009394772350788116, -0.02028629370033741, 0.005876744166016579, 0.0035013232845813036, 0.001454151701182127, 0.0013388886582106352, 0.0034278221428394318, 0.007363469805568457, -0.013938473537564278, -0.003938988782465458, -0.0030035206582397223, 0.031351543962955475, -0.005415691994130611, -5.966741082374938e-05, -0.00815193634480238, -0.023453520610928535, 0.0033242525532841682, -0.013190099969506264, 0.00894040148705244, 4.421548146638088e-05, -0.009795687161386013, 0.0366436205804348, 0.03838091716170311, -0.006070519331842661, 0.002985145431011915, -0.0073768338188529015, 0.006190794054418802, -0.0022417823784053326, 0.0003395247913431376, -0.009795687161386013, 0.011259025894105434, 0.0013413943815976381, 0.016156869009137154, -0.00046397544792853296, 0.013357147574424744, 0.002037984086200595, 0.00633111409842968, 0.01369792502373457, 0.02532445639371872, -0.011025159619748592, -0.011018477380275726, 0.012909458950161934, 0.01821490004658699, 0.012174448929727077, 0.007991570048034191, 0.0020663822069764137, 0.015114490874111652, -0.011599804274737835, -0.016223689541220665, -0.012575363740324974, -0.01876281574368477, 0.008198709227144718, 0.017907531931996346, -0.03602888435125351, 0.0069425092078745365, 0.030897174030542374, -0.018976638093590736, -0.0016445862129330635, -0.007189739961177111, -0.014272569678723812, 0.010510651394724846, -0.0017122406279668212, -0.010717791505157948, -0.02297242172062397, -0.005054868292063475, -0.011847035028040409, -0.028758959844708443, 0.017052246257662773, 0.019190458580851555, -0.017119064927101135, -0.021208398044109344, 0.01977846771478653, 0.020272929221391678, 0.02448253519833088, 0.01476703118532896, -0.017078973352909088, -0.011045204475522041, -0.011873762123286724, -0.007884658873081207, -0.01285600382834673, -0.00790470466017723, -0.004065945278853178, -0.0023520339746028185, -0.013965201564133167, -0.01658451184630394, -0.004102695733308792, 0.023573795333504677, 0.00835239328444004, -0.008312301710247993, 0.024963634088635445, -0.02078075520694256, -0.001546027953736484, 0.017225975170731544, 0.0008164464379660785, -0.025284364819526672, -0.011272390373051167, -0.022143865004181862, 0.045089561492204666, -0.010557425208389759, -0.006895735859870911, -0.018963273614645004, 0.009842460043728352, 0.03223355486989021, 0.023680705577135086, -0.016063323244452477, 0.00888026412576437, 0.018842998892068863, -0.0380067303776741, -0.0032490810845047235, 0.006989282555878162, -0.013437330722808838, 0.027302302420139313, 0.0037318493705242872, 0.02151576429605484, 0.0014975841622799635, -0.02392125502228737, 0.02716866508126259, -0.02744930610060692, 0.0190434567630291, -0.01721261255443096, -0.025123998522758484, 0.01793425902724266, 0.023012513294816017, 0.0017523320857435465, -0.0025207523722201586, 0.008566214703023434, 0.01579604670405388, 0.00958186574280262, 0.023333245888352394, 0.014740304090082645, -0.021662767976522446, -0.006321091204881668, -0.012735729105770588, -0.007737657055258751, 0.0008348217234015465, -0.020553570240736008, -0.0011451131431385875, -0.001046554883942008, 0.007844568230211735, -0.013056461699306965, -0.012194493785500526, 0.0022885557264089584, 0.020687207579612732, 0.011613167822360992, 0.0015000898856669664, -0.014914033934473991, 0.03490632399916649, 0.048002876341342926, 0.006982600782066584, 0.0020914392080157995, -0.016945336014032364, -0.013016370125114918, 0.008265528827905655, -0.02969442866742611, 0.011339209042489529, -0.0017673664260655642, 0.0008619669824838638, 0.01168666873127222, 0.010276785120368004, -0.0005433231708593667, 0.005412350874394178, 0.010470559820532799, -0.002478990238159895, 0.02242450602352619, 0.01479375921189785, -0.01168666873127222, -0.006618436425924301, -0.012735729105770588, -0.02191668003797531, -0.0024923542514443398, -0.010931611992418766, 0.01084474753588438, -0.00537894107401371, -0.01207421999424696, -0.0037819636054337025, -0.6679776310920715, -0.02621983364224434, 0.002986815758049488, -0.028037313371896744, -0.0014691860415041447, -0.010777927935123444, 0.002400477882474661, 0.005285394378006458, -0.006083883345127106, 0.018869727849960327, 0.014499754644930363, -0.008552851155400276, 0.01224126759916544, -0.0171457938849926, 0.005763151217252016, -0.0055727167055010796, 0.012702319771051407, -0.03151191025972366, -0.010884839110076427, -0.0009956052526831627, -0.018629178404808044, 0.014606665819883347, -0.0008293926366604865, -0.02667420357465744, 0.029667701572179794, 0.02074066363275051, -0.00491788936778903, -0.002844825154170394, -0.00012445065658539534, 0.026527201756834984, 0.004393358714878559, 0.02487008646130562, 0.01269563753157854, -0.001051566330716014, 0.04252370446920395, -0.012789184227585793, -0.002276862505823374, 0.019644828513264656, 0.018736088648438454, 0.04067949578166008, -0.03485286608338356, -0.01479375921189785, 0.0037585769314318895, 0.014833850786089897, 0.009682094678282738, 0.006397933233529329, 0.021422218531370163, 0.01392510998994112, 0.0023937958758324385, -0.00229857861995697, 0.009261134080588818, -0.006678573787212372, 0.004299812018871307, 0.0001725813199300319, 0.0069425092078745365, 0.008726580999791622, 0.006842280738055706, 0.00018062051094602793, -0.011633213609457016, -0.004279766231775284, -0.008091798983514309, 0.0216226764023304, -0.019350824877619743, 0.005061550531536341, 0.011780215427279472, 0.005719718988984823, -0.014579937793314457, 0.0075839729979634285, 0.0013104905374348164, -0.018562359735369682, 0.004954639822244644, 0.0069425092078745365, -0.018963273614645004, -0.0251106359064579, -0.0015635680174455047, 0.0027412555646151304, 0.02902623638510704, -0.0169186070561409, 0.014379479922354221, 0.006140679586678743, -0.006691937334835529, -0.009755595587193966, -0.02560509741306305, -0.0029417129699140787, 0.014112203381955624, -0.017065610736608505, -0.039423298090696335, -0.007831203751266003, 0.01911027543246746, -0.00641463790088892, -0.0005287064705044031, -0.0003854629467241466, -0.0042530386708676815, -0.019417643547058105, -0.007196422200649977, 0.02107475884258747, 0.007791112642735243, 0.015983140096068382, 0.00381871429271996, -0.013871654868125916, -0.008506077341735363, 0.017720438539981842, 0.001601153751835227, 0.004129423294216394, 0.0012745752464979887, -0.030282437801361084, 0.019471099600195885, 0.020967848598957062, 0.04185551404953003, -0.009802368469536304, -0.003504664171487093, -0.01921718567609787, -0.01961810141801834, -0.018455447629094124, 0.00696255499497056, -0.02790367603302002, 0.008171981200575829, 0.0013155019842088223, 0.004433450289070606, -0.007229831535369158, -0.0027646422386169434, -0.02470972016453743, -0.008432576432824135, -0.0012887743068858981, -0.006798848044127226, 0.015288220718502998, -0.005856698378920555, -0.01266222819685936, -0.03749890625476837, -0.005936881061643362, -0.004059263039380312, 0.012114311568439007, 0.0145665742456913, -0.013677879236638546, -0.010490605607628822, 0.002395466435700655, 0.001536005176603794, -0.017359614372253418, -0.009094085544347763, -0.0002994333044625819, -0.029320241883397102, -0.0008602965390309691, 0.00487445667386055, 0.010183237493038177, -0.012902777642011642, -0.014299297705292702, -0.0048911613412201405, -0.009114131331443787, -0.009795687161386013, 0.015515405684709549, 0.015007580630481243, -0.013597696088254452, -0.011900490149855614, -0.00835239328444004, -0.0021783041302114725, -0.009481636807322502, 0.005475828889757395, -0.013738016597926617, -0.02130194380879402, -0.020366474986076355, 0.011800261214375496, 0.020660480484366417, -0.017747165635228157, -3.450582516961731e-05, 0.0018675951287150383, 9.834943193709478e-05, -0.0030669989064335823, 0.025418004021048546, -0.0022551461588591337, -0.029400425031781197, 0.0030853741336613894, 0.0049780262634158134, 0.009114131331443787, 0.007036055903881788, -0.019765103235840797, 0.011813624761998653, -0.0216226764023304, -0.02017938159406185, 0.0035614604130387306, 0.010183237493038177, -0.013163371942937374, 0.006581685971468687, 0.0029199966229498386, 0.002216725144535303, 0.027582943439483643, 0.016397418454289436, -0.014299297705292702, 0.029988432303071022, -0.005863380152732134, 0.016611238941550255, 0.00274459645152092, -0.000925445172470063, 0.0021916679106652737, 0.000588843715377152, 0.007984887808561325, 0.025418004021048546, -0.00790470466017723, 0.009742231108248234, 0.003665030235424638, 0.025284364819526672, 0.0356546975672245, 0.011025159619748592, 0.017239339649677277, -0.008225437253713608, 0.0024338874500244856, -0.03132481500506401, 0.015208037570118904, -0.01754670776426792, 0.010223329067230225, -0.010490605607628822, 0.003695098916068673, -0.03250083327293396, -0.009929325431585312, -0.01145948376506567, 0.008886946365237236, 0.006708642467856407, -0.008272210136055946, 0.019858650863170624, -0.02593919262290001, 0.020807482302188873, 0.00403253547847271, 0.016958698630332947, -0.0005253655253909528, -0.017800619825720787, -0.008673124946653843, 0.028170952573418617, -0.002001233398914337, 0.022558143362402916, 0.013965201564133167, -0.019030092284083366, -0.014326024800539017, -0.011245662346482277, 0.004136105068027973, 0.005973631516098976, 0.037899818271398544, 0.024241985753178596, 0.017800619825720787, -0.021195033565163612, 0.02218395657837391, 0.020914392545819283, -0.009855824522674084, 0.020580297335982323, 0.03282156586647034, -0.0061640664935112, 0.03244737908244133, 0.0027128574438393116, 0.04661303758621216, 0.016223689541220665, -0.012455089017748833, 0.007831203751266003, -0.01876281574368477, -0.0009805710287764668, -0.010116418823599815, -0.014499754644930363, -0.005853357259184122, 0.0009722185786813498, 0.021529128775000572, -0.005876744166016579, 0.005392305087298155, 0.03209991753101349, -0.0008490207837894559, -0.024843359366059303, -0.022290866822004318, -0.019872013479471207, 0.017052246257662773, -0.020246202126145363, -0.009782322682440281, 0.006895735859870911, -0.0258322823792696, -0.034051038324832916, -0.005860039032995701, -0.010430469177663326, -0.002881575608626008, -0.0145665742456913, 0.012735729105770588, 0.008806763216853142, -0.005251985043287277, 0.018575722351670265, 0.0291331484913826, 0.021154941990971565, -0.016277143731713295, -0.0035614604130387306, 0.016798334196209908, -0.0023754206486046314, -0.005669604521244764, 0.0039957850240170956, -0.015288220718502998, -0.012201176024973392, -0.008893628604710102, -0.0023804320953786373, -0.020887665450572968, -0.0034378450363874435, -0.007543881423771381, -0.0009287861175835133, 0.015515405684709549, -0.0014967488823458552, 0.018562359735369682, -0.021422218531370163, -0.013457376509904861, -0.015314948745071888, -0.0011167150223627687, 0.018482176586985588, -0.009180950932204723, -0.029373696073889732, 0.04511628672480583, -0.0028197679203003645, 0.009247769601643085, -0.026861296966671944, 0.008679807186126709, -0.025979284197092056, -0.002001233398914337, -0.0032223532907664776, 0.010330240242183208, 0.0020847574342042208, 0.0237074326723814, -0.01353087741881609, -0.0190434567630291, 0.006575004197657108, 0.02028629370033741, 0.02662074752151966, -0.0385412834584713, -0.01703888177871704, 0.001225296058692038, 0.0005646217614412308, 0.08397830277681351, 0.030282437801361084, -0.016878517344594002, 0.0036449844483286142, 0.0033877308014780283, -0.0044301096349954605, -0.017399705946445465, -0.04573102295398712, 0.019992288202047348, 0.0042530386708676815, -0.0003875510592479259, -0.002303590066730976, -0.009708821773529053, 0.005074914079159498, 0.02274523675441742, -0.006778802257031202, 0.02307933382689953, -0.04265734180808067, -0.0014508106978610158, -0.0385412834584713, 0.005966949742287397, 0.038300734013319016, 0.017680346965789795, 0.0106776999309659, -0.0006347818998619914, -0.022050319239497185, 0.004035876598209143, -0.018107987940311432, 0.019965561106801033, -0.018134716898202896, -0.018228262662887573, 0.015902956947684288, 0.015007580630481243, 0.015528769232332706, 0.006113952025771141, 0.04343244433403015, 0.006130656693130732, 0.048056330531835556, 0.013150008395314217, -0.004590475466102362, 0.02286551147699356, -0.002866541501134634, -0.004904525354504585, -0.029721155762672424, 0.002858188934624195, 0.00190935714635998, -0.008853537030518055, 0.013330419547855854, 0.0005312121938914061, -0.04092004522681236, 0.014499754644930363, -0.0009120813338086009, -0.011071932502090931, 0.009140859358012676, 0.0060070413164794445, 0.005382282193750143, 0.0005374765023589134, 0.0075104720890522, 0.006661869119852781, 0.006020405329763889, -0.012401633895933628, -0.0041327644139528275, 0.01725270412862301, -0.004971344489604235, -0.0038821923080831766, -0.015221402049064636, -0.008866900578141212, -0.004490246530622244, -0.016878517344594002, 0.014392844401299953, 0.000386506988434121, -0.008586260490119457, -0.045249927788972855, 0.005723060108721256, 0.033917397260665894, 0.020152654498815536, 0.02134203538298607, -0.0007425277726724744, 0.0013597696088254452, -0.00020171029609628022, 0.0038621467538177967, -0.05479170009493828, 0.02044665813446045, -0.020379839465022087, 0.009989462792873383, 0.00169887684751302, -0.00968877598643303, 0.0038588056340813637, -0.02744930610060692, 0.007891341112554073, -0.008158617652952671, 0.03164554759860039, 0.003655007341876626, -0.04124077782034874, 0.006725347135215998, -0.022330958396196365, -0.011606485582888126, 0.019591374322772026, 0.018107987940311432, -0.02242450602352619, -0.000752133026253432, -0.016103414818644524, -0.010824701748788357, -0.026353470981121063, -0.014967489056289196, 0.0027045048773288727, 0.017346249893307686, 0.01609005033969879, -0.03020225465297699, -0.014700212515890598, 0.037792909890413284, -0.011539666913449764, 0.02028629370033741, 0.025618460029363632, 0.026300016790628433, 0.03592197224497795, -0.00537894107401371, 0.004363290499895811, -0.016557784751057625, -0.014005293138325214, 0.016116777434945107, -0.025845644995570183, 0.02393461763858795, 0.0017473206389695406, -0.05217238888144493, 0.013156689703464508, 0.002027961192652583, -0.029240058735013008, -0.014045384712517262, 0.02012592740356922, -0.021876588463783264, 0.03362339362502098, -0.008058388717472553, -0.016624603420495987, -0.027823492884635925, -0.011679986491799355, -0.011753488332033157, 0.014072111807763577, -0.0029617587570101023, 0.021114850416779518, 0.01670478656888008, -0.04011821374297142, -0.007664156146347523, -0.0014357763575389981, -0.011546348221600056, -0.023600522428750992, 0.0011943922145292163, 0.0033593326807022095, -0.029881522059440613, 0.015649044886231422, 0.0058333114720880985, 0.0057497876696288586, -0.01282927580177784, -0.0025859009474515915, -0.012321450747549534, -0.02112821489572525, 0.011700032278895378, 0.005839993245899677, 0.029988432303071022, -0.00790470466017723, 0.032581016421318054, 0.00038608937757089734, 0.0244290791451931, 0.010751200839877129, 0.005779856350272894, 0.02251805178821087, -0.01288941316306591, -0.0024288760032504797, -0.012414997443556786, -0.012802548706531525, 0.010657654143869877, -0.014579937793314457, 0.0022300889249891043, -0.0030803626868873835, 0.009127495810389519, 0.012020764872431755, 0.013844926841557026, 0.0002992244844790548, -0.0008628022042103112, -0.025752099230885506, -0.014753667637705803, 0.0064580705948174, -0.0001062320006894879, 0.005251985043287277, 0.011847035028040409, 0.001282927580177784, 0.0018174807773903012, 0.016611238941550255, 0.012441725470125675, 0.015675771981477737, 0.009789004921913147, 0.01000282634049654, 0.0075839729979634285, -0.0007145472336560488, 0.01870936155319214, -0.029293512925505638, -0.018107987940311432, -0.03065662458539009, 0.009274497628211975, 0.015582225285470486, 0.014967489056289196, -0.0031622161623090506, -0.005228598136454821, -0.014486391097307205, -0.021836496889591217, -7.203939458122477e-05, -0.022237412631511688, 0.0007220644038170576, -0.008278892375528812, 0.012414997443556786, -0.025190819054841995, -0.022491324692964554, -0.0052820537239313126, -0.0227986928075552, -0.01984528638422489, -0.026807840913534164, -0.009628638625144958, -0.0031354883685708046, -0.014112203381955624, -0.040599312633275986, 0.004623884800821543, -0.019684920087456703, 0.0432453528046608, 0.009882551617920399, -0.0013113257009536028, 0.014726939611136913, 0.011599804274737835, 0.0030168844386935234, 0.006534912623465061, 0.008846854791045189, -0.00686232652515173, 0.01653105765581131, 0.027823492884635925, -0.0014992546057328582, -0.013778108172118664, 0.003224023850634694, -0.004316516686230898, -0.02482999488711357, -0.022451233118772507, -0.00031822617165744305, 0.009033948183059692, -0.028865871950984, -0.007062783930450678, -0.008673124946653843, -0.03340957313776016, 0.020085835829377174, -0.011446120217442513, 0.010223329067230225, -0.011185524985194206, -0.004557065665721893, -0.012481817044317722, 0.012909458950161934, -0.01742643304169178, -0.005719718988984823, 0.004012489691376686, -0.014780395664274693, -0.0035146870650351048, -0.030282437801361084, 0.009862505830824375, 0.01905682124197483, -0.021034667268395424, 0.011192207224667072, -0.01870936155319214, 0.017225975170731544, 0.012254631146788597, 0.0082321185618639, -0.014940761029720306, -0.018682632595300674, 0.0043733129277825356, 0.027876947075128555, 0.025618460029363632, -0.0011451131431385875, -0.0053689186461269855, 0.011873762123286724, -0.005703014321625233, 0.02309269644320011, 0.0008097645477391779, -0.012702319771051407, -0.008646397851407528, 0.002174963243305683, 0.02230423130095005, 0.011132069863379002, -0.00563285406678915, 0.006591708865016699, -0.009795687161386013, 0.0014508106978610158, 0.0011167150223627687, -0.0028064041398465633, 0.00018082931637763977, -0.04255043342709541, -0.016825061291456223, -0.012969596311450005, 0.019978925585746765, 0.012394951656460762, -0.0076775201596319675, -0.0025792191736400127, 0.0164642371237278, 0.022491324692964554, -0.003788645612075925, -0.005860039032995701, 0.0075906552374362946, -0.02679447829723358, -0.016878517344594002, 0.021783042699098587, -0.022437868639826775, -0.02230423130095005, 0.02795713022351265, -0.008666443638503551, -0.018455447629094124, -0.010343603789806366, 0.013096552342176437, -0.0038621467538177967, 0.008198709227144718, 0.0057130372151732445, 0.012702319771051407, 0.004096013493835926, 0.009461591020226479, -0.011365937069058418, -0.007911386899650097, 0.011385982856154442, -0.01137261837720871, -0.00040342059219256043, 0.01586286537349224, 0.0069959647953510284, 0.007470380514860153, 0.0042563797906041145, 0.013210144825279713, 0.01395183801651001, -0.04308498650789261, -0.005569376051425934, -0.006922463420778513, 0.02251805178821087, -0.005165120121091604, -0.013116598129272461, -0.018629178404808044, -0.0036516664549708366, -0.0042563797906041145, 0.006063837558031082, 0.007310014683753252, -0.005576057825237513, -0.030950628221035004, 0.03683071210980415, 0.004500269424170256, 0.019257277250289917, 0.005733083002269268, -0.007209785748273134, -0.03669707477092743, -0.01428593322634697, -0.045864664018154144, 0.010383695363998413, 0.0033693555742502213, 0.03736526519060135, 0.00763742858543992, -0.007717611268162727, -0.02246459759771824, -0.020593661814928055, -0.010644289664924145, -0.003219012403860688, 0.01308318879455328, 0.007517153862863779, 0.026821205392479897, -0.011065250262618065, -0.001971164718270302, 0.014593301340937614, -0.011118706315755844, -0.0031221245881170034, -0.008472668007016182, -0.017666982486844063, -6.018943531671539e-05, 0.008559532463550568, -0.004009148571640253, -0.0034194698091596365, 0.012067537754774094, -0.007664156146347523, -0.009588547982275486, 0.010457196272909641, 0.015074399299919605, -0.010884839110076427, 0.0002493189531378448, -0.006902417633682489, 0.007142966613173485, -0.0014299297472462058, 0.005839993245899677, 0.0151545824483037, 0.007837885990738869, -0.008158617652952671, -0.0007379339658655226, 0.007503790315240622, -0.015902956947684288, 0.005442419555038214, -0.00983577873557806, 0.0010022871429100633, -0.0194978266954422, -0.0052419621497392654, -0.025979284197092056, -0.018615813925862312, 0.006341136991977692, 0.00658502709120512, -0.0009129166137427092, -0.02437562495470047, -0.00015598094614688307, 0.015248129144310951, -0.013831563293933868, -0.011659940704703331, -0.017078973352909088, -0.0022100433707237244, -0.034104492515325546, -0.009368044324219227, -0.00037376960972324014, -0.015288220718502998, -0.007644110359251499, 0.01849553920328617, -0.007263241335749626, -0.011065250262618065, -0.01333710178732872, -0.00803834293037653, 0.007911386899650097, 0.000741692550946027, 0.0005349707789719105, 0.007864613085985184, 0.009595229290425777, 0.00935468077659607, 0.0003084121271967888, 0.011045204475522041, -0.0035247099585831165, -0.0347459577023983, 0.002382102655246854, -0.009200996719300747, -0.001236154232174158, 0.016771605238318443, -0.015729226171970367, -0.007710929494351149, 0.004817660432308912, 0.02549818716943264, 0.003695098916068673, 0.009060676209628582, 0.23627249896526337, -0.00633111409842968, 0.006324432324618101, 0.021863223984837532, -0.003618256887421012, 0.015114490874111652, 0.01204749196767807, 0.0044267685152590275, -0.0029884863179177046, 0.037792909890413284, -0.010911566205322742, -0.01647760160267353, -0.02337333746254444, -0.0022417823784053326, -0.021048031747341156, -0.005753128323704004, -0.02179640531539917, -0.009167586453258991, -0.02980133891105652, -0.014967489056289196, 0.0150209441781044, 0.0056595816276967525, -0.009875870309770107, -0.01016987394541502, 0.025083906948566437, 0.029881522059440613, 0.01770707406103611, 0.0009237747290171683, 0.017386341467499733, 0.012602090835571289, -0.012809230014681816, 0.00941481813788414, -0.002240111818537116, -0.01849553920328617, -0.006210839841514826, 0.003718485590070486, 0.0031488523818552494, 0.01955128274857998, 0.0006686091073788702, -0.00554933026432991, 0.012374905869364738, -0.018134716898202896, -0.02307933382689953, -0.018361901864409447, 0.00877335388213396, 0.003812032286077738, -0.015475314110517502, -0.013711288571357727, 0.014392844401299953, 0.03530723601579666, -0.019805194810032845, -0.0150209441781044, 0.04161496460437775, 0.029293512925505638, 0.003065328346565366, -0.015087762847542763, 0.01204749196767807, 0.005235279910266399, 0.015368403866887093, 0.016517693176865578, 0.009575183503329754, 0.021208398044109344, -0.01742643304169178, 0.015595588833093643, -0.006832257844507694, 0.004376654047518969, -0.018348537385463715, 0.012962914071977139, 0.023600522428750992, -0.02330651879310608, -0.023293154314160347, 0.011499575339257717, -0.005819947458803654, -0.0024054893292486668, -0.022905603051185608, -0.030175525695085526, 0.0319395512342453, 0.018522268161177635, 0.011973991058766842, 0.02679447829723358, -0.010630926117300987, -0.013283646665513515, -0.012040810659527779, -0.012094265781342983, -0.000909575610421598, -0.033142298460006714, 0.012067537754774094, -0.001827503670938313, -0.016343962401151657, 0.00479093287140131, -0.003825396066531539, -0.011058568954467773, -0.019818559288978577, -0.011058568954467773, 0.009762276895344257, -0.004924571141600609, -0.007096193265169859, 0.047094132751226425, -0.0022735213860869408, 0.010717791505157948, -0.016343962401151657, 0.015034307725727558, 0.017225975170731544, 0.006227544508874416, -0.018482176586985588, 0.013136643916368484, 0.005038163624703884, 0.016891879960894585, 0.02337333746254444, 0.0018208217807114124, -0.017747165635228157, -0.015568860806524754, 0.006581685971468687, -0.009408135898411274, -0.0021198373287916183, 0.018174808472394943, -0.007243195548653603, -0.04495592042803764, -0.010290148667991161, -0.002427205443382263, -0.02051347866654396, -0.017733801156282425, -0.01933746039867401, 0.030362620949745178, -0.014980852603912354, 0.01331037376075983, -0.03071008063852787, 0.0038220551796257496, 0.013283646665513515, -0.01143275573849678, -0.010944976471364498, -0.01359101478010416, -0.0085728969424963, -0.020473387092351913, -0.01658451184630394, -0.007557245437055826, 0.007056101690977812, 0.025351183488965034, 0.0019126980332657695, -0.00289159850217402, 0.011512938886880875, 0.0027663125656545162, -0.0028715527150779963, -0.0029584176372736692, 0.01204749196767807, -0.02897278219461441, 0.010483924299478531, 0.0057497876696288586, 0.007423607166856527, -0.025364547967910767, -0.006882372312247753, 0.01101179514080286, 0.00038253961247392, 0.0013447352685034275, 0.0017857416532933712, -0.009655366651713848, -0.0019611420575529337, -0.049339257180690765, -0.003444527043029666, -0.00789802335202694, -0.0450628325343132, 0.02711520902812481, 0.018134716898202896, -0.025645188987255096, -0.021114850416779518, -0.025311091914772987, -0.17180539667606354, 0.006548276171088219, 0.019457735121250153, -0.017239339649677277, 0.03161881864070892, -0.0019076865864917636, 0.031244633719325066, 0.015141218900680542, -0.02230423130095005, 0.01804116927087307, 0.006798848044127226, -0.012127675116062164, -0.0157425906509161, -0.022317595779895782, -0.0015811080811545253, -0.008619669824838638, -0.012000719085335732, 0.0036115748807787895, 0.010236693546175957, 0.006788825150579214, 0.020206110551953316, -0.0057497876696288586, -0.01754670776426792, 0.003741872264072299, 0.025204181671142578, -0.0075104720890522, 0.0037685998249799013, 0.013631106354296207, 0.0031404998153448105, -0.03177918493747711, 0.005375600419938564, 0.021021302789449692, -0.008659761399030685, -0.021662767976522446, 0.023680705577135086, -0.006575004197657108, 0.0018976638093590736, -0.022651690989732742, -0.01302305143326521, 0.015956413000822067, 0.016731513664126396, 0.03266119956970215, 0.01731952279806137, -0.026527201756834984, 0.007396879605948925, 0.0035714833065867424, 0.022384414449334145, -0.020313020795583725, 0.008258846588432789, 0.013096552342176437, -0.0003034006804227829, -0.0404389463365078, 0.008359075523912907, -0.016784969717264175, 0.020139290019869804, -0.0156089523807168, 0.005385623313486576, 0.0333828441798687, -0.00561614939942956, -0.007310014683753252, -0.01698542758822441, -0.04027858003973961, 0.010323558002710342, 0.014259206131100655, -0.0033760373480618, -0.017747165635228157, -0.01916373148560524, -0.0042496975511312485, -0.04778905212879181, 0.018923182040452957, -0.009207678027451038, -0.021943407133221626, 0.015141218900680542, -0.025030452758073807, 0.007817840203642845, 0.0060404506511986256, -0.03822055086493492, 0.030843717977404594, 0.011379300616681576, 0.0246562659740448, 0.0015752613544464111, 0.0329284742474556, 0.003802009392529726, 0.010751200839877129, 0.014018656685948372, 0.01933746039867401, 0.014299297705292702, 0.011967308819293976, -0.014927397482097149, -0.031404998153448105, -0.012969596311450005, -0.0021281898953020573, -1.846661916715675e-06, 0.0024121711030602455, -0.003765258938074112, 0.017840711399912834, 0.0024255351163446903, 0.002995168324559927, 0.022491324692964554, -0.03447867929935455, 0.015421858988702297, -0.009033948183059692, -0.020246202126145363, -0.011392664164304733, 0.04998072236776352, 0.008359075523912907, -0.016156869009137154, 0.03872837871313095, 0.023547066375613213, 0.007343424018472433, -0.02219732105731964, 0.025070544332265854, 0.008592941798269749, 0.032073188573122025, 0.007964842021465302, 0.029908249154686928, 0.019511191174387932, -0.02348024770617485, -0.0001744606124702841, -0.005672945640981197, 0.048056330531835556, 0.003952352330088615, -0.00994268897920847, 0.008686489425599575, -0.001754002645611763, -0.001293785753659904, -0.10140473395586014, -0.00021778864902444184, 1.3207221854827367e-05, -0.011766851879656315, 0.002134871669113636, 0.06013723090291023, -0.009922643192112446, 0.023800980299711227, -0.028732232749462128, 0.02079411782324314, -0.010236693546175957, -0.029507335275411606, 0.011907171458005905, -0.005816606804728508, -0.009080721996724606, -0.009929325431585312, -0.0006635976606048644, -0.018629178404808044, -0.025591732934117317, 0.023226335644721985, 0.0010348615469411016, -0.009254451841115952, -0.007109557278454304, 0.004156150855123997, 0.01703888177871704, -8.023517875699326e-05, -0.011392664164304733, 0.00958186574280262, 0.012234585359692574, 0.02750276029109955, -0.010884839110076427, -0.00453701987862587, 0.00474750017747283, -0.005318804178386927, 0.013036415912210941, 0.003728508483618498, -0.02672765776515007, -0.004523656331002712, 0.009207678027451038, -0.008198709227144718, 0.01016987394541502, 0.011720078065991402, 0.009936006739735603, -0.04247025027871132, 0.0078044761903584, -0.007076147478073835, -0.016825061291456223, 0.02023283764719963, 0.029293512925505638, -0.019484462216496468, -0.02051347866654396, 0.0113993464037776, -0.023293154314160347, -0.018589086830615997, 0.023787615820765495, 0.002280203392729163, 0.02083420939743519, 0.021154941990971565, -0.009247769601643085, 0.007416925393044949, 0.0034745957236737013, -0.03407776355743408, 0.002458944683894515, 0.007837885990738869, -0.007891341112554073, -0.0145665742456913, -0.008165299892425537, -0.021996863186359406, -0.0036516664549708366, -0.02891932614147663, -0.01476703118532896, 0.015475314110517502, -0.031110994517803192, 0.008085116744041443, -0.005388963967561722, -0.0022835442796349525, -0.011873762123286724, -0.0032958544325083494, 0.01635732688009739, -0.013450694270431995, -0.002971781650558114, -0.01182030700147152, 0.008245483040809631, -0.01269563753157854, 0.011045204475522041, 0.01591632142663002, -0.012388269416987896, -0.0003320076211821288, -0.009067358449101448, 3.5889188438886777e-05, -0.009621957316994667, 0.02795713022351265, 0.009655366651713848, -0.0006924134213477373, 0.022571507841348648, 0.004466860089451075, -0.009889233857393265, -0.005609467159956694, -0.006778802257031202, 0.010216647759079933, -0.023346610367298126, 0.014232478104531765, -0.0691177248954773, 0.023613886907696724, -0.0024940245784819126, -0.026821205392479897, 0.006230885628610849, 0.009996144101023674, 0.013297010213136673, -0.03295520320534706, -0.014032021164894104, -0.002427205443382263, -0.03904910758137703, 0.01865590550005436, -0.005185165908187628, -0.010938294231891632, -0.015141218900680542, -0.005933540407568216, 0.021208398044109344, 0.01372465305030346, 0.0024572741240262985, -0.00291331484913826, 0.010236693546175957, -0.01882963627576828, -0.0015811080811545253, 0.01854899525642395, -0.0008586260373704135, 4.8626588977640495e-05, -0.013858291320502758, 9.166751988232136e-05, -0.01224126759916544, -0.0011994036613032222, -0.018241627141833305, 0.010029553435742855, -0.004927912261337042, -0.01372465305030346, -0.007884658873081207, 0.01781398430466652, -0.007350106257945299, 0.0006702795508317649, -0.000768002588301897, 0.05896121636033058, -0.0034979823976755142, -0.006377887446433306, 0.0016921948408707976, -0.03680398687720299, 0.010129782371222973, 0.02028629370033741, -0.001617023372091353, 0.0076775201596319675, 0.034826140850782394, -0.02174295112490654, 0.008118526078760624, 0.012582045048475266, -0.01983192190527916, -0.016771605238318443, -0.0017139110714197159, -0.027329031378030777, -0.019016729667782784, -0.02046002261340618, 0.018802907317876816, -0.0037919864989817142, 0.006448047701269388, 0.0074102431535720825, 0.003289172425866127, -0.015515405684709549, 0.02179640531539917, -0.024562718346714973, 0.024923542514443398, 0.023600522428750992, 0.01754670776426792, -0.018121352419257164, -0.014833850786089897, -0.003504664171487093, 0.003257433418184519, 0.017065610736608505, 0.007784430403262377, -0.018856363371014595, -0.0032774792052805424, 0.03776618093252182, -0.009922643192112446, 0.00964200310409069, -0.0039957850240170956, -0.007543881423771381, 0.008265528827905655, 0.010116418823599815, 0.037739455699920654, -0.005806583911180496, 0.007122920826077461, 0.007924750447273254, -0.008071753196418285, 0.015435222536325455, 0.0003113354614470154, -0.006357841659337282, -0.012000719085335732, -0.028064042329788208, -0.00854616891592741, 0.011178843677043915, -0.010437150485813618, 0.02728893980383873, 0.013818199746310711, 0.009989462792873383, 0.016170233488082886, 0.01145948376506567, 0.006848962511867285, -0.018856363371014595, -0.03715144470334053, 0.049953993409872055, -0.0018358560046181083, -0.03397085517644882, -0.013684561476111412, 0.014686848036944866, -0.0026310039684176445, 0.021716222167015076, 0.008399167098104954, 0.016905244439840317, -0.013804835267364979, 0.012568681500852108, -0.01325023639947176, -0.013043097220361233, -0.0156089523807168, 0.020941119641065598, 0.01726606674492359, 0.015622316859662533, 0.02739585004746914, -0.01944437250494957, 0.009187632240355015, 0.021435583010315895, 0.021609311923384666, 0.010985068045556545, -0.004446814302355051, -0.0023470225278288126, -0.01658451184630394, -0.012194493785500526, 0.005221916362643242, -0.0004228399193380028, 0.022598234936594963, 0.010684381239116192, -0.009715504013001919, 0.014165659435093403, -0.01870936155319214, 0.05885430425405502, 0.006174088921397924, -0.011365937069058418, 0.008913674391806126, 0.017119064927101135, 0.019791830331087112, 0.00043766541057266295, -0.018963273614645004, 0.003608233993873, 0.009568502195179462, 0.030629897490143776, 0.0017239339649677277, 0.004009148571640253, -0.059656135737895966, 0.0036583482287824154, -0.0042530386708676815, -0.00941481813788414, 0.015836138278245926, -0.008733262307941914, 0.010443832725286484, 0.006334455218166113, 0.028812415897846222, 0.009682094678282738, 0.01933746039867401, -0.026206469163298607, 0.0069090998731553555, 0.02964097261428833, -0.0016571148298680782, -0.019123639911413193, -0.04960653558373451, -0.004500269424170256, 0.0005846675485372543, -0.03354321047663689, -0.025645188987255096, 0.001717252074740827, -0.02112821489572525, -0.0042196293361485004, -0.01162653136998415, 0.023346610367298126, 0.020647116005420685, -0.01614350639283657, -0.005138392560184002, -0.031191177666187286, -0.01607668586075306, -0.00025808895588852465, -0.009989462792873383, -0.017693709582090378, 0.00757729122415185, -0.009214360266923904]) as score where contains(text, '{search_text}')) order by score ASC limit 4"

    view = vector_store.dataset.filter(filter_fn)
    view_value = view.text.data(aslist=True)["value"]
    view_value_0 = view[0].text.data(aslist=True)["value"]

    view1 = vector_store.dataset.query(
        f"select * where contains(text, '{search_text}')"
    )
    view1_value = view1.text.data(aslist=True)["value"]
    view1_value_0 = view1[0].text.data(aslist=True)["value"]

    view2 = vector_store.dataset.query(TQL_QUERY)
    view2_value = view2.text.data(aslist=True)["value"]
    view2_value_0 = view2[0].text.data(aslist=True)["value"]

    assert view_value == view1_value == view2_value
    assert view_value_0 == view1_value_0 == view2_value_0
